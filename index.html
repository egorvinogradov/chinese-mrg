<!DOCTYPE html>
<html>
<head>
  <title>Chinese MRG</title>
  <meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
<style>

  body, input {
    font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica Neue, sans-serif;
  }
  .words {
    max-width: 700px;
    width: 100%;
    border-collapse: collapse;
    margin: 46px auto 100px auto;
  }
  .words td {
    padding: 4px;
  }
  .words tr:nth-child(odd) td {
    background: #f6f6f6;
  }
  .words tr:hover td {
    background: #eee;
  }
  .chinese {
    font-size: 24px;
    font-family: 'Kaiti SC', 'Times New Roman', sans-serif;
  }
  .chinese.selected:after {
    content: attr(data-text);
    position: fixed;
    background: #fff;
    box-shadow: 0 1px 13px rgba(0,0,0,0.1);
    text-align: center;
    font-size: 70px;
    bottom: 0;
    left: 0;
    right: 0;
  }
  .search {
    height: 40px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    text-align: center;
    white-space: nowrap;
  }
  .search-input {
    width: 100%;
    max-width: 700px;
    box-shadow: 0 8px 5px -5px rgba(0,0,0,0.07);
    padding: 10px 15px;
    box-sizing: border-box;
    height: 46px;
    border: 0;
    border-bottom: 1px solid rgba(0,0,0,.1);
    font-size: 16px;
  }
  .search-clear {
    display: inline-block;
    height: 46px;
    width: 46px;
    margin-left: -50px;
    font-size: 30px;
    line-height: 40px;
    cursor: pointer;
    position: relative;
    z-index: 1;
    vertical-align: top;
  }
</style>
  <div class="search">
    <input class="search-input" type="text" placeholder="Найти..." spellcheck="false">
    <span class="search-clear">&times;</span>
  </div>
  <table class="words">
    <colgroup>
      <col width="25%">
      <col width="30%">
      <col width="45%">
    </colgroup>
    <tbody></tbody>
  </div>
  <script>

    function iterateDOM(selector, callback){
      return Array.prototype.slice.call(document.querySelectorAll(selector)).map(callback);
    }

    function renderWords(words){
      var tableHTML = words.map(row => {
        return `<tr>
          <td><span class="chinese" data-text="${row.chinese}">${row.chinese}</span></td>
          <td>${row.pinyin}</td>
          <td>${row.russian}</td>
        </tr>`;
      }).join('\n');

      document.querySelector('.words tbody').innerHTML = tableHTML;

      iterateDOM('.chinese', (td) => {
        td.addEventListener('click', (e) => {
          setTimeout(() => {
            e.target.classList.add('selected');
          }, 100);
        }, false);
      })
    }

    function hidePopups(){
      iterateDOM('.chinese.selected', (item) => item.classList.remove('selected'));
    }

    var isSearching = false;

    function normalizeStr(str){
      return str.toLowerCase()
        .replace(/[\s+⟨⟩\-_,;\?\!\.]+/g, '')
        .replace(/[īíǐì]/g, 'i')
        .replace(/[āáǎà]/g, 'a')
        .replace(/[ōóǒò]/g, 'o')
        .replace(/[ēéěè]/g, 'e')
        .replace(/[ūúǔùüǚǖǘǚǜ]/g, 'u');
    }

    function prepareSearchDict(){
      window.words = window.words.map(item => {
        item.search = normalizeStr(item.chinese + ' ' + item.pinyin + ' ' + item.russian);
        return item;
      });
    }

    function initSearch(){

      prepareSearchDict();

      document.querySelector('.search-input').addEventListener('keyup', (e) => {
        if (!isSearching) {
          isSearching = true;
          setTimeout(() => {
            isSearching = false;
            performSearch(e.target.value);
          }, 500);
          performSearch(e.target.value);
        }
      }, false);
    }

    function performSearch(text){
      var keyword = normalizeStr(text.trim());
      if (keyword) {
        renderWords( getSearchMatches(keyword, window.words) );
      }
      else {
        renderWords(window.words);
      }
    }

    function getSearchMatches(keyword, allWords) {
      return allWords.filter(item => {
        return item.search.indexOf(keyword) > -1;
      });
    }

    async function init(){
      window.words = await fetch('/data/words.json').then(data => data.json());

      renderWords(words);
      document.querySelector('body').addEventListener('click', hidePopups, false);
      document.querySelector('body').addEventListener('touchstart', hidePopups, false);
      document.addEventListener('keyup', (e) => {
        if (e.which === 27) {
          hidePopups();
        }
      }, false);

      document.querySelector('.search-clear').addEventListener('click', () => {
        var input = document.querySelector('.search-input');
        input.value = '';
        input.focus();
        renderWords(window.words);
      }, false);

      window.addEventListener('keydown', (e) => {
        if (e.keyCode === 70 && (e.ctrlKey || e.metaKey)) {
          document.querySelector('.search-input').focus();
          e.preventDefault();
          return false;
        }
      });

      initSearch();
    }

    init();

  </script>
</body>
</html>
